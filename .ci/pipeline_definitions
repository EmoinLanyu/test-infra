test-infra:
  template: 'default'
  base_definition:
    repo: ~
    traits:
      scheduling:
        suppress_parallel_execution: true
      version:
        preprocess:
          'inject-commit-hash'
        inject_effective_version: true
      notifications:
        default:
          on_error:
            triggering_policy: 'only_first'
      publish:
        dockerimages:
          tm-controller:
            registry: 'gcr-readwrite'
            image: eu.gcr.io/gardener-project/gardener/testmachinery/testmachinery-controller
            dockerfile: 'Dockerfile'
            target_name: tm-controller
            tag_as_latest: true
          tm-run:
            registry: 'gcr-readwrite'
            image: eu.gcr.io/gardener-project/gardener/testmachinery/testmachinery-run
            dockerfile: 'Dockerfile'
            target_name: tm-run
            tag_as_latest: true
    steps:
      check:
        image: 'golang:1.11.1'
      test:
        image: 'golang:1.11.1'
  variants:
    head-update:
      traits:
        draft_release: ~
      steps:
        integration:
          image: 'eu.gcr.io/gardener-project/cc/job-image-golang:0.5.0'
          depends:
          - publish
    release:
      traits:
        version:
          preprocess: 'finalize'
        release:
          nextversion: 'bump_minor'
      steps:
        deploy:
          image: 'eu.gcr.io/gardener-project/cc/job-image-golang:0.5.0'
          depends:
          - release

test-infra-golang:
  template: 'default'
  variants:
    release-image:
      traits:
        version:
          preprocess: 'finalize'
          inject_effective_version: true
        publish:
          dockerimages:
            tm-golang:
              registry: 'gcr-readwrite'
              image: eu.gcr.io/gardener-project/gardener/testmachinery/golang
              dockerfile: 'Dockerfile'
              dir: 'hack/images/golang'
              tag_as_latest: true

test-infra-prepare:
  template: 'default'
  variants:
    release-image:
      traits:
        version:
          preprocess: 'finalize'
          inject_effective_version: true
        publish:
          dockerimages:
            tm-prepare:
              registry: 'gcr-readwrite'
              image: eu.gcr.io/gardener-project/gardener/testmachinery/prepare-step
              dockerfile: 'Dockerfile'
              dir: 'hack/images/prepare'
              tag_as_latest: true

test-infra-base:
  template: 'default'
  variants:
    release-image:
      traits:
        version:
          preprocess: 'finalize'
          inject_effective_version: true
        publish:
          dockerimages:
            tm-base:
              registry: 'gcr-readwrite'
              image: eu.gcr.io/gardener-project/gardener/testmachinery/base-step
              dockerfile: 'Dockerfile'
              dir: 'hack/images/base'
              tag_as_latest: true
